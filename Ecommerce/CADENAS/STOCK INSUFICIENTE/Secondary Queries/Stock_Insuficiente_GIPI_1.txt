// Stock_Insuficiente_GIPI_1
let
    Source = DB2.Database("ieecdb2v3:50000", "inditex", [HierarchicalNavigation=true, Implementation="IBM", Query="-- IBM DB2 - GIPI IRLANDA - STOCK INSUFICIENTE - BERSHKA - PARTE 1#(lf)SELECT #(lf)#(tab)p.COD_PEDIDO_WCS,#(lf)#(tab)ep.DESCRIPCION,#(lf)#(tab)tienda.nombre AS TIENDA_VIRTUAL,#(lf)#(tab)p.FECHA_HORA_PEDIDO AS FECHA_PEDIDO,#(lf)#(tab)pcom.COMENTARIO AS COMENTARIO,#(lf)#(tab)pac.FECHA_HORA_ACCION AS FECHA_INSUFICIENTE,#(lf)#(tab)pcom.FECHA_HORA_COMENTARIO AS FECHA_RESOLUCION_INSUFICIENTE#(lf)FROM GIPI_ITX.pedido p#(lf)INNER JOIN maestros.entidad_ecommerce tienda #(lf)#(tab)ON tienda.id_entidad_ecommerce = p.id_entidad_ecommerce#(lf)#(tab)#(tab)AND tienda.id_cadena = 4 -- BERSHKA#(lf)INNER JOIN GIPI_ITX.PEDIDO_ACCION pac#(lf)#(tab)ON pac.id_pedido = p.id_pedido #(lf)#(tab)#(tab)AND pac.id_accion = 82 -- PASÓ A INSUFICIENTE#(lf)INNER JOIN GIPI_ITX.pedido_comentario pcom #(lf)#(tab)ON pcom.id_Pedido = p.id_pedido#(lf)INNER JOIN GIPI_ITX.estado_pedido ep#(lf)#(tab)ON ep.ID_ESTADO_PEDIDO = p.ID_ESTADO_PEDIDO#(lf)WHERE #(lf)#(tab)pac.FECHA_HORA_ACCION >= CURRENT TIMESTAMP - 30 DAYS#(lf)#(tab)AND p.FECHA_HORA_PEDIDO >= CURRENT TIMESTAMP - 30 DAYS#(lf)#(tab)AND (pcom.comentario LIKE ('Se ha eliminado%') #(lf)#(tab)#(tab)OR pcom.COMENTARIO LIKE ('Pedido%') #(lf)#(tab)#(tab)#(tab)OR PCOM.COMENTARIO LIKE ('Articulo%'))#(lf)#(tab)AND pcom.COMENTARIO <> 'Pedido actualizado automáticamente' #(lf)#(tab)AND pcom.COMENTARIO <> 'Pedido unitario'#(lf)UNION#(lf)SELECT #(lf)#(tab)p.COD_PEDIDO_WCS,#(lf)#(tab)ep.DESCRIPCION,#(lf)#(tab)tienda.nombre AS TIENDA_VIRTUAL,#(lf)#(tab)p.FECHA_HORA_PEDIDO AS FECHA_PEDIDO,#(lf)#(tab)'CANCELACION MANUAL POR INSUFICIENTE' AS COMENTARIO,#(lf)#(tab)PAC.FECHA_HORA_ACCION AS FECHA_INSUFICIENTE,#(lf)#(tab)P.FECHA_MODIFICACION AS FECHAS_RESOLUCION_INSUFICIENTE #(lf)FROM GIPI_ITX.pedido p#(lf)INNER JOIN maestros.entidad_ecommerce tienda #(lf)#(tab)ON tienda.id_entidad_ecommerce = p.id_entidad_ecommerce #(lf)#(tab)#(tab)AND tienda.id_cadena = 4 -- BERSHKA#(lf)INNER JOIN GIPI_ITX.pedido_accion pac #(lf)#(tab)ON pac.id_pedido = p.id_pedido #(lf)#(tab)#(tab)AND pac.id_accion = 82 #(lf)#(tab)#(tab)#(tab)AND P.EN_COMPASS = 0 #(lf)#(tab)#(tab)#(tab)#(tab)AND ID_ESTADO_PEDIDO = 9#(lf)INNER JOIN GIPI_ITX.estado_pedido ep#(lf)#(tab)ON ep.ID_ESTADO_PEDIDO = p.ID_ESTADO_PEDIDO#(lf)WHERE #(lf)#(tab)pac.FECHA_HORA_ACCION >= CURRENT TIMESTAMP - 30 DAYS#(lf)#(tab)AND p.FECHA_HORA_PEDIDO >= CURRENT TIMESTAMP - 30 DAYS#(lf)WITH UR;", CommandTimeout=#duration(0, 7, 0, 0)])
in
    Source