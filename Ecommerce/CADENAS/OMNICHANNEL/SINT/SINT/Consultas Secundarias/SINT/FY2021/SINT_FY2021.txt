// Bershka_SINT_FY2021
let
    Source = DB2.Database("axindb2tndg6v1:50000", "inditex", [HierarchicalNavigation=true, Implementation="IBM", Query="-- IBM DB2 - LOGISTICS TIENDA ENTORNO PRO - OMNICHANNEL - BERSHKA - SINT - FY2021#(lf)WITH #(lf)#(tab)PED_PICKING AS #(lf)#(tab)(#(lf)#(tab)#(tab)SELECT #(lf)#(tab)#(tab)#(tab)p.ID_PEDIDO, #(lf)#(tab)#(tab)#(tab)MIN(p.FECHA_ALTA) AS FECHA_INICIO_PICKING,#(lf)#(tab)#(tab)#(tab)MAX(p.FECHA_MODIFICACION) AS FECHA_FIN_PICKING#(lf)#(tab)#(tab)FROM ECLOG_CADENAS_TND.OLEADA_PICKING_IPOD o#(lf)#(tab)#(tab)INNER JOIN ECLOG_CADENAS_TND.OLEADA_PICKING_IPOD_PEDIDO p #(lf)#(tab)#(tab)#(tab)ON o.ID_OLEADA_PICKING_IPOD = p.ID_OLEADA_PICKING_IPOD#(lf)#(tab)#(tab)#(tab)#(tab)AND ID_ESTADO_OLEADA_PICKING = 3#(lf)#(tab)#(tab)WHERE #(lf)#(tab)#(tab)#(tab)p.FECHA_ALTA >= '2021-01-01 00:00:00.000'#(lf)          #(tab)#(tab)       AND p.FECHA_ALTA < '2022-03-01 00:00:00.000'#(lf)#(tab)#(tab)GROUP BY #(lf)#(tab)#(tab)#(tab)p.ID_PEDIDO#(lf)#(tab))#(lf)SELECT#(lf)#(tab)zz.PAIS AS COD_PAIS,#(lf)#(tab)zz.ID_LOCALIZACION AS STORE_CODE,#(lf)#(tab)zz.DESCRIPCION AS STORE,#(lf)#(tab)zz.COD_PEDIDO_WCS AS ORDER_CODE,#(lf)#(tab)zz.ARTICULOS AS UNITS,#(lf)#(tab)zz.FECHA_HORA_COMPRA_LOCAL AS LOCAL_PURCHASE_DATE,#(lf)#(tab)FROM_UTC_TIMESTAMP(TIMESTAMP(zz.FECHA_HORA_NOTIFICACION), zz.HUSO_HORARIO) AS LOCAL_RECEPTION_DATE,#(lf)#(tab)FROM_UTC_TIMESTAMP(TO_UTC_TIMESTAMP(TIMESTAMP(zz.FECHA_EMPAQUETADO), 'Europe/Madrid'), zz.HUSO_HORARIO) AS LOCAL_PACKING_DATE,#(lf)#(tab)FROM_UTC_TIMESTAMP(TO_UTC_TIMESTAMP(TIMESTAMP(zz.FECHA_EXP), 'Europe/Madrid'), zz.HUSO_HORARIO) AS LOCAL_EXPEDITION_DATE,#(lf)#(tab)FROM_UTC_TIMESTAMP(TO_UTC_TIMESTAMP(TIMESTAMP(zz.FECHA_DESESTIMACION), 'Europe/Madrid'), zz.HUSO_HORARIO) AS LOCAL_REJECTION_DATE,#(lf)#(tab)FROM_UTC_TIMESTAMP(TO_UTC_TIMESTAMP(TIMESTAMP(zz.FECHA_CANCELACION), 'Europe/Madrid'), zz.HUSO_HORARIO) AS LOCAL_CANCELLATION_DATE,#(lf)#(tab)FROM_UTC_TIMESTAMP(TO_UTC_TIMESTAMP(TIMESTAMP(zz.FECHA_INICIO_PICKING), 'Europe/Madrid'), zz.HUSO_HORARIO) AS LOCAL_PICKING_START_DATE,#(lf)#(tab)FROM_UTC_TIMESTAMP(TO_UTC_TIMESTAMP(TIMESTAMP(zz.FECHA_FIN_PICKING), 'Europe/Madrid'), zz.HUSO_HORARIO) AS LOCAL_PICKING_END_DATE,#(lf)        FROM_UTC_TIMESTAMP(TO_UTC_TIMESTAMP(TIMESTAMP(CURRENT_TIMESTAMP), 'Europe/Madrid'), zz.HUSO_HORARIO) AS LOCAL_CURRENT_DATETIME,#(lf)#(tab)zz.FECHA_HORA_MAXIMA_PREPARACION,#(lf)#(tab)zz.NOMBRE_ESTADO_PEDIDO AS STATUS,#(lf)#(tab)COALESCE(zz.RAZON_ANULACION,'') AS CANCEL_REASON,#(lf)#(tab)CASE#(lf)#(tab)#(tab)WHEN zz.ID_ESTADO_PEDIDO = 1 #(lf)#(tab)#(tab)THEN 'Received'#(lf)#(tab)#(tab)ELSE CASE#(lf)#(tab)#(tab)#(tab)WHEN zz.ID_ESTADO_PEDIDO IN (2, 4, 40, 3) #(lf)#(tab)#(tab)#(tab)THEN 'Picking process'#(lf)#(tab)#(tab)#(tab)#(lf)ELSE CASE#(lf)   WHEN (zz.ID_ESTADO_PEDIDO = 32 and zz.ID_RAZON_ANULACION_PEDIDO = 4)#(lf)   THEN 'Expired'#(lf)ELSE CASE#(lf)#(tab)#(tab)#(tab)#(tab)WHEN zz.ID_ESTADO_PEDIDO IN (7, 8, 9) #(lf)#(tab)#(tab)#(tab)#(tab)THEN 'Packing process'#(lf)#(tab)#(tab)#(tab)#(tab)ELSE CASE#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)WHEN zz.ID_ESTADO_PEDIDO IN (5, 10) #(lf)#(tab)#(tab)#(tab)#(tab)#(tab)THEN 'Packed'#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)ELSE CASE#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)WHEN zz.ID_ESTADO_PEDIDO IN (6, 12) #(lf)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)THEN 'Shipped'#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)ELSE CASE#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)WHEN zz.ID_ESTADO_PEDIDO = 31#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)OR  (zz.ID_ESTADO_PEDIDO = 32#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)AND zz.ID_RAZON_ANULACION_PEDIDO = 5)#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)THEN 'Cancelled'#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)ELSE 'Rejected'#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)#(tab)END#(lf)#(tab)#(tab)#(tab)#(tab)#(tab)END#(lf)#(tab)#(tab)#(tab)#(tab)END#(lf)#(tab)#(tab)#(tab)END#(lf)END#(lf)#(tab)#(tab)END#(lf)#(tab)END AS STATUS_EQUIVALENTE,#(lf)#(tab)zz.TRANSPORTISTA AS COURIER,#(lf)#(tab)CASE#(lf)#(tab)#(tab)WHEN (zz.ID_TIPO_OPERATIVA_PEDIDO in (1,20) and zz.ID_METODO_TRANSPORTE IN (2,3)) THEN 'Standard'#(lf)#(tab)#(tab)WHEN (zz.ID_TIPO_OPERATIVA_PEDIDO in (2,21) OR (zz.ID_TIPO_OPERATIVA_PEDIDO = 1 AND zz.ID_METODO_TRANSPORTE = 4 AND zz.ID_LOCALIZACION = zz.LOCALIZACION_ENTREGA ) ) THEN 'Same Store'#(lf)#(tab)#(tab)WHEN (zz.ID_TIPO_OPERATIVA_PEDIDO in (22) OR (zz.ID_TIPO_OPERATIVA_PEDIDO = 1 AND zz.ID_METODO_TRANSPORTE = 4 AND zz.ID_LOCALIZACION != zz.LOCALIZACION_ENTREGA ))  THEN 'Other Store'#(lf)#(tab)#(tab)WHEN (zz.ID_TIPO_OPERATIVA_PEDIDO in (22) and zz.ID_METODO_TRANSPORTE in (6,7)) THEN 'Drop Point'#(lf)#(tab)#(tab)WHEN (zz.ID_TIPO_OPERATIVA_PEDIDO in (20) and zz.ID_METODO_TRANSPORTE  = 14) THEN 'Deferred Standart'#(lf)#(tab)#(tab)WHEN (zz.ID_TIPO_OPERATIVA_PEDIDO in (20) and zz.ID_METODO_TRANSPORTE  = 13) THEN 'Home Assembly'#(lf)#(tab)#(tab)#(tab)ELSE 'NA'#(lf)#(tab)END AS TIPO_ENVIO,#(lf)#(tab)CASE#(lf)#(tab)#(tab)WHEN zz.ATRIBUTOS IN (4096, 5120)#(lf)#(tab)#(tab)THEN 'FAST SINT'#(lf)#(tab)#(tab)ELSE 'SINT'#(lf)#(tab)END AS OPERATION_TYPE,#(lf)#(tab)zz.CUENTA_CAJAS AS BUNDLES,#(lf)#(tab)(#(lf)#(tab)#(tab)SELECT#(lf)#(tab)#(tab)#(tab)LISTAGG(TCE.DESCRIPCION, '; ')#(lf)#(tab)#(tab)FROM ECLOG_CADENAS_TND.TIPO_CAJA_ECOMMERCE tce#(lf)#(tab)#(tab)INNER JOIN ECLOG_CADENAS_TND.CAJA_PEDIDO cp#(lf)#(tab)#(tab)ON cp.ID_TIPO_CAJA_ECOMMERCE = tce.ID_TIPO_CAJA_ECOMMERCE#(lf)#(tab)#(tab)#(tab)AND cp.ID_PEDIDO = zz.ID_PEDIDO#(lf)#(tab)#(tab)GROUP BY#(lf)#(tab)#(tab)#(tab)cp.ID_PEDIDO #(lf)#(tab)#(tab)WITH UR #(lf)#(tab)) AS BUNDLES_SIZE,#(lf)#(tab)zz.IMPORTE_TOTAL AS TOTAL_IMPORT,#(lf)#(tab)zz.MONEDA AS CURRENCY,#(lf)#(tab)zz.ID_TIPO_OPERATIVA_PEDIDO,#(lf)        zz.BLOQUEO_PEDIDO_TRANSPORTISTA,#(lf)   #(tab)zz.BLOQUEO_DOCUMENTACION#(lf)FROM #(lf)(#(lf)#(tab)SELECT#(lf)#(tab)#(tab)sub.ID_PEDIDO,#(lf)#(tab)#(tab)sub.ID_SUBPEDIDO,#(lf)#(tab)#(tab)ped.FECHA_HORA_COMPRA AS FECHA_HORA_COMPRA,#(lf)#(tab)#(tab)ped.ID_ESTADO_PEDIDO,#(lf)#(tab)#(tab)ep.DESCRIPCION AS NOMBRE_ESTADO_PEDIDO,#(lf)#(tab)#(tab)rap.DESCRIPCION AS RAZON_ANULACION,#(lf)#(tab)#(tab)ped.NUMERO_UNIDADES AS ARTICULOS,#(lf)#(tab)#(tab)ped.COD_PEDIDO_WCS,#(lf)#(tab)#(tab)ROW_NUMBER() OVER( ORDER BY ped.FECHA_MODIFICACION DESC, ped.FECHA_HORA_COMPRA_LOCAL DESC ) AS RN,#(lf)#(tab)#(tab)ll.DESCRIPCION,#(lf)#(tab)#(tab)ll.ID_LOCALIZACION,#(lf)#(tab)#(tab)ped.FECHA_HORA_COMPRA_LOCAL,#(lf)#(tab)#(tab)ped.FECHA_HORA_NOTIFICACION,#(lf)#(tab)#(tab)ped.FECHA_MODIFICACION,#(lf)#(tab)#(tab)ped.ID_RAZON_ANULACION_PEDIDO,#(lf)#(tab)#(tab)gd.ID_GRUPO_DISTRIBUCION,#(lf)#(tab)#(tab)e.FECHA_ALTA AS FECHA_EXPEDICION,#(lf)#(tab)#(tab)ll.HUSO_HORARIO,#(lf)#(tab)#(tab)gd.ID_PAIS AS PAIS,#(lf)#(tab)#(tab)ped.IMPORTE_TOTAL,#(lf)#(tab)#(tab)ped.MONEDA,#(lf)#(tab)#(tab)ped.ID_TIPO_OPERATIVA_PEDIDO,#(lf)#(tab)#(tab)et.NOMBRE AS TRANSPORTISTA,#(lf)#(tab)#(tab)ci.DESCRIPCION AS NOMBRE_CADENA,#(lf)#(tab)#(tab)ped.ID_LOCALIZACION_ENTREGA AS LOCALIZACION_ENTREGA,#(lf)#(tab)#(tab)ped.ID_METODO_TRANSPORTE,#(lf)#(tab)#(tab)ped.ATRIBUTOS,#(lf)#(tab)#(tab)ped.FECHA_HORA_MAXIMA_PREPARACION AS FECHA_HORA_MAXIMA_PREPARACION,#(lf)#(tab)#(tab)COUNT(DISTINCT cp.ID_CAJA_PEDIDO) AS CUENTA_CAJAS,#(lf)#(tab)#(tab)cepemp.FECHA_HORA_SISTEMA AS FECHA_EMPAQUETADO,#(lf)#(tab)#(tab)cepexp.FECHA_HORA_SISTEMA AS FECHA_EXP,#(lf)#(tab)#(tab)cepfd.FECHA_HORA_SISTEMA AS FECHA_DESESTIMACION,#(lf)#(tab)#(tab)cepfc.FECHA_HORA_SISTEMA AS FECHA_CANCELACION,#(lf)#(tab)#(tab)FECHA_INICIO_PICKING,#(lf)#(tab)#(tab)FECHA_FIN_PICKING,#(lf)                ped.BLOQUEO_PEDIDO_TRANSPORTISTA,#(lf)#(tab)#(tab)ped.BLOQUEO_DOCUMENTACION#(lf)#(tab)FROM ECLOG_CADENAS_TND.SUBPEDIDO sub#(lf)#(tab)INNER JOIN ECLOG_CADENAS_TND.LOCALIZACION_GRUPO_DISTRIBUCION lgd#(lf)#(tab)#(tab)ON lgd.ID_LOCALIZACION = sub.ID_LOCALIZACION -- AND lgd.ID_GRUPO_DISTRIBUCION = 214#(lf)#(tab)INNER JOIN ECLOG_CADENAS_TND.PEDIDO ped#(lf)#(tab)#(tab)ON sub.FECHA_ALTA >= '2021-02-01 00:00:00.000'#(lf)#(tab)#(tab)AND sub.FECHA_ALTA < '2022-02-01 00:00:00.000'#(lf)#(tab)#(tab)AND ped.FECHA_ALTA >= '2021-02-01 00:00:00.000'#(lf)#(tab)#(tab)AND ped.FECHA_ALTA < '2022-02-01 00:00:00.000'#(lf)#(tab)#(tab)AND ped.ID_PEDIDO = sub.ID_PEDIDO#(lf)#(tab)#(tab)AND ped.ID_TIPO_OPERATIVA_PEDIDO IN (2, 20, 21, 22) -- 3 para PAT#(lf)#(tab)#(tab)AND (ped.ID_RAZON_ANULACION_PEDIDO IS NULL #(lf)#(tab)#(tab)#(tab)OR  ped.ID_RAZON_ANULACION_PEDIDO IN (1, 2, 3, 4, 6, 5, 7, 8, 10, 101))#(lf)#(tab)#(tab)AND ( ped.PENDIENTE_ALARMAR IS NULL#(lf)#(tab)#(tab)#(tab)OR  ped.PENDIENTE_ALARMAR IN (1,0))#(lf)#(tab)#(tab)AND ped.ID_ESTADO_PEDIDO IN (1, 2, 4, 3, 32, 12, 7, 8, 9, 10, 40, 5, 6, 0)#(lf)#(tab)#(tab)AND sub.ID_LOCALIZACION = lgd.ID_LOCALIZACION#(lf)#(tab)INNER JOIN ECLOG_CADENAS_TND.ESTADO_PEDIDO ep#(lf)#(tab)#(tab)ON ep.ID_ESTADO_PEDIDO = ped.ID_ESTADO_PEDIDO#(lf)#(tab)LEFT JOIN ECLOG_CADENAS_TND.RAZON_ANULACION_PEDIDO rap#(lf)#(tab)#(tab)ON rap.ID_RAZON_ANULACION_PEDIDO = ped.ID_RAZON_ANULACION_PEDIDO#(lf)/* #(tab)INNER JOIN ECLOG_CADENAS_TND.LINEA_PEDIDO lin #(lf)#(tab)#(tab)ON lin.ID_SUBPEDIDO = sub.ID_SUBPEDIDO */#(lf)#(tab)INNER JOIN ECLOG_CADENAS_TND.GRUPO_DISTRIBUCION gd#(lf)#(tab)#(tab)ON gd.ID_GRUPO_DISTRIBUCION = ped.ID_GRUPO_DISTRIBUCION#(lf)#(tab)#(tab)#(tab)AND gd.ID_CADENA = 4 -- BERSHKA  #(lf)#(tab)INNER JOIN MAESTROS.LOCALIZACION LL#(lf)#(tab)#(tab)ON ll.ID_LOCALIZACION = sub.ID_LOCALIZACION#(lf)#(tab)INNER JOIN ECLOG_CADENAS_TND.EMPRESA_TRANSPORTE et#(lf)#(tab)#(tab)ON et.ID_EMPRESA_TRANSPORTE = ped.ID_EMPRESA_TRANSPORTE_ENTREGA#(lf)/* #(tab)LEFT JOIN ECLOG_CADENAS_TND.CAJA_PEDIDO_LINEA_PEDIDO cp #(lf)#(tab)#(tab)ON cp.ID_LINEA_PEDIDO = lin.id_LINEA_PEDIDO */#(lf)#(tab)LEFT JOIN ECLOG_CADENAS_TND.CAJA_PEDIDO cp #(lf)#(tab)#(tab)ON cp.ID_PEDIDO = ped.ID_PEDIDO#(lf)#(tab)INNER JOIN ECLOG_CADENAS_TND.CADENA_INFORMACION ci#(lf)#(tab)#(tab)ON ci.id_cadena = gd.id_cadena#(lf)#(tab)LEFT JOIN ECLOG_CADENAS_TND.EXPEDICION e#(lf)#(tab)#(tab)ON e.ID_EXPEDICION = ped.ID_EXPEDICION#(lf)#(tab)LEFT JOIN ECLOG_CADENAS_TND.CAMBIO_ESTADO_PEDIDO cepemp#(lf)#(tab)#(tab)ON cepemp.ID_PEDIDO = ped.ID_PEDIDO#(lf)#(tab)#(tab)#(tab)AND cepemp.ID_ESTADO_PEDIDO IN (5, 10)#(lf)#(tab)LEFT JOIN ECLOG_CADENAS_TND.CAMBIO_ESTADO_PEDIDO cepexp#(lf)#(tab)#(tab)ON cepexp.ID_PEDIDO = ped.ID_PEDIDO#(lf)#(tab)#(tab)#(tab)AND cepexp.ID_ESTADO_PEDIDO IN (6, 12)#(lf)#(tab)LEFT JOIN ECLOG_CADENAS_TND.CAMBIO_ESTADO_PEDIDO cepfd#(lf)#(tab)#(tab)ON cepfd.ID_PEDIDO = ped.ID_PEDIDO#(lf)#(tab)#(tab)#(tab)AND cepfd.ID_ESTADO_PEDIDO = 32#(lf)#(tab)#(tab)#(tab)AND ped.ID_RAZON_ANULACION_PEDIDO != 5#(lf)#(tab)LEFT JOIN ECLOG_CADENAS_TND.CAMBIO_ESTADO_PEDIDO cepfc#(lf)#(tab)#(tab)ON cepfc.ID_PEDIDO = ped.ID_PEDIDO#(lf)#(tab)#(tab)#(tab)AND cepfc.ID_ESTADO_PEDIDO = 32#(lf)#(tab)#(tab)#(tab)AND ped.ID_RAZON_ANULACION_PEDIDO = 5#(lf)#(tab)LEFT JOIN PED_PICKING#(lf)#(tab)#(tab)ON PED_PICKING.ID_PEDIDO = ped.ID_PEDIDO#(lf)#(tab)WHERE#(lf)#(tab)#(tab)1 = 1#(lf)#(tab)GROUP BY#(lf)#(tab)#(tab)sub.ID_SUBPEDIDO,#(lf)#(tab)#(tab)sub.CODIGO_UNIFICADO,#(lf)#(tab)#(tab)ped.FECHA_HORA_COMPRA,#(lf)#(tab)#(tab)ped.FECHA_HORA_MAXIMA_PICKING,#(lf)#(tab)#(tab)ped.ID_ESTADO_PEDIDO,#(lf)#(tab)#(tab)ep.DESCRIPCION,#(lf)#(tab)#(tab)rap.DESCRIPCION,#(lf)#(tab)#(tab)ped.ID_TIPO_DIVISION_PEDIDO,#(lf)#(tab)#(tab)sub.NUMERO_IMPRESIONES_PICKING,#(lf)#(tab)#(tab)ped.FECHA_HORA_EXPIRACION,#(lf)#(tab)#(tab)sub.ID_PEDIDO,#(lf)#(tab)#(tab)ped.COD_PEDIDO_WCS,#(lf)#(tab)#(tab)ll.DESCRIPCION,#(lf)#(tab)#(tab)ll.ID_LOCALIZACION,#(lf)#(tab)#(tab)ped.FECHA_HORA_COMPRA_LOCAL,#(lf)#(tab)#(tab)ped.FECHA_HORA_NOTIFICACION,#(lf)#(tab)#(tab)ped.FECHA_MODIFICACION,#(lf)#(tab)#(tab)ped.ID_RAZON_ANULACION_PEDIDO,#(lf)#(tab)#(tab)gd.ID_GRUPO_DISTRIBUCION,#(lf)#(tab)#(tab)gd.DIFERENCIA_HORAS,#(lf)#(tab)#(tab)e.FECHA_ALTA,#(lf)#(tab)#(tab)ll.HUSO_HORARIO,#(lf)#(tab)#(tab)gd.ID_PAIS,#(lf)#(tab)#(tab)ped.IMPORTE_TOTAL,#(lf)#(tab)#(tab)ped.MONEDA,#(lf)#(tab)#(tab)ped.ID_TIPO_OPERATIVA_PEDIDO,#(lf)#(tab)#(tab)et.NOMBRE,#(lf)#(tab)#(tab)ci.DESCRIPCION,#(lf)#(tab)#(tab)ped.ID_LOCALIZACION_ENTREGA,#(lf)#(tab)#(tab)ped.ID_METODO_TRANSPORTE,#(lf)#(tab)#(tab)ped.ATRIBUTOS,#(lf)#(tab)#(tab)ped.FECHA_HORA_MAXIMA_PREPARACION,#(lf)#(tab)#(tab)ped.BLOQUEO_PEDIDO_TRANSPORTISTA,#(lf)#(tab)#(tab)ped.BLOQUEO_DOCUMENTACION,#(lf)#(tab)#(tab)ped.NUMERO_UNIDADES,#(lf)#(tab)#(tab)cepemp.FECHA_HORA_SISTEMA,#(lf)#(tab)#(tab)cepexp.FECHA_HORA_SISTEMA,#(lf)#(tab)#(tab)cepfd.FECHA_HORA_SISTEMA,#(lf)#(tab)#(tab)cepfc.FECHA_HORA_SISTEMA,#(lf)#(tab)#(tab)FECHA_INICIO_PICKING,#(lf)#(tab)#(tab)FECHA_FIN_PICKING #(lf)) AS zz#(lf)WHERE#(lf)#(tab)1 = 1#(lf)WITH UR;", CommandTimeout=#duration(0, 7, 0, 0)])
in
    Source