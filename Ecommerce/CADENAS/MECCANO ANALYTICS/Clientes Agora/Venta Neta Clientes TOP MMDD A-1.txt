// Venta Neta Clientes TOP MMDD A-1
let
    Origen = Sql.Database("anl-meccano-sql.database.windows.net", "anlmeccanodw", [Query="SET DATEFIRST 1 -- ( Monday )#(lf)#(lf)--------------------------------------------------------------------------------------------------------------------------------#(lf)declare @year int#(lf)declare @yearA1 int#(lf)declare @yearA2 int#(lf)declare @FechaIni nvarchar(60), @FechaFin  nvarchar(60)#(lf)declare @FechaIniA1 nvarchar(60), @FechaFinA1  nvarchar(60)#(lf)declare @FechaIniA2 nvarchar(60), @FechaFinA2  nvarchar(60)#(lf)declare @EJFiscal int, @EJFiscalA1 int, @EJFiscalA2 int#(lf) #(lf)set @year = year(sysdatetime())#(lf)set @yearA1 = @year-1#(lf)set @yearA2 = @year-2#(lf)#(lf)SET @FechaIni = CONCAT(cast(@year as varchar(10)),'-02-01 00:00:00') #(lf)SET @FechaFin = CONCAT(cast(sysdatetime() as varchar(10)),' 23:59:59') #(lf)#(lf)select @EJFiscal = case when month(getdate()) > 1 then year(getdate()) else year(getdate())-1 end#(lf)set @EJFiscalA1 = @EJFiscal-1#(lf)set @EJFiscalA2 = @EJFiscal-2#(lf)#(lf)SET @FechaIniA1 = CONCAT(cast(@yearA1 as varchar(10)),'-02-01 00:00:00')#(lf)SET @FechaFinA1 = CONCAT(cast(@year as varchar(10)),'-01-31 23:59:59')#(lf)#(lf)#(lf)SET @FechaIniA2 = CONCAT(cast(@yearA2 as varchar(10)),'-02-01 00:00:00')#(lf)SET @FechaFinA2 = CONCAT(cast(@yearA1 as varchar(10)),'-01-31 23:59:59')#(lf)#(lf)--select @FechaIni,@FechaFin,@FechaIniA1,@FechaFinA1,@FechaIniA2,@FechaFinA2#(lf)#(lf)--------------------------------------------------------------------------------------------------------------------------------#(lf)/*with tabla_dates (ano, semana,lunes)#(lf)as (select ANO, SEMANA, min(FECHA_PEDIDO) as lunes#(lf)from (select distinct DATEPART(yy,FECHA_PEDIDO) AS ANO, DATEPART(wk,FECHA_PEDIDO) AS SEMANA, FECHA_PEDIDO#(lf)      from dbo_st.stg_ult_estado_linea_pedido_st #(lf)      where FECHA_PEDIDO >= '2018-01-01 00:00:00' and FECHA_PEDIDO <= '2022-02-02 00:00:00'#(lf)      and ID_CADENA in (6, 15) and ID_CENTRO_COMPRA in (2, 13, 16, 31)) a#(lf)group by ANO, SEMANA)#(lf)*/#(lf)--------------------------------------------------------------------------------------------------------------------------------#(lf)--FY ACTUAL#(lf)--------------------------------------------------------------------------------------------------------------------------------#(lf)select Base.ID_PAIS, Base.DESC_PAIS,#(lf)#(tab)#(tab)MMDD.IMPORTE_NETO_MMDD_A_1 IMPORTE_NETO_MMDD_A_1#(lf)from (select 1 as ID_PAIS, 'FRANCIA' DESC_PAIS#(lf)      UNION#(lf)#(tab)  select 38 as ID_PAIS, 'MEXICO' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 4 as ID_PAIS, 'ALEMANIA' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 2 as ID_PAIS, 'BELGICA' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 5 as ID_PAIS, 'ITALIA' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 6 as ID_PAIS, 'UK' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 3 as ID_PAIS, 'HOLANDA' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 30 as ID_PAIS, 'RUSIA' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 11 as ID_PAIS, 'ESPAÃ‘A' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 25 as ID_PAIS, 'POLONIA' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 21 as ID_PAIS, 'TURQUIA' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 10 as ID_PAIS, 'PORTUGAL' DESC_PAIS#(lf)#(tab)  UNION#(lf)#(tab)  select 0  as ID_PAIS, 'TODOS' DESC_PAIS) Base #(lf)#(tab)  --PAISES A MOSTRAR#(lf)join#(lf)(#(lf)Select TOTAL_ANO.ID_PAIS,sum(MMDD.IMPORTE_NETO) IMPORTE_NETO_MMDD_A_1 from #(lf)(select A.ID_PAIS as ID_PAIS,A.EMAIL as EMAIL,Sum(A.NUM_PEDIDOS) as NUM_PEDIDOS ,sum(A.IMPORTE_NETO) as IMPORTE_NETO,sum(IMPORTE_BRUTO) as IMPORTE_BRUTO,Rank() OVER(ORDER BY sum(A.IMPORTE_NETO) DESC) AS RanKing,B.RanKing as RanKing_A1,B.IMPORTE_NETO as IMPORTE_NETO_A1#(lf)#(tab)  from (select a.ID_PAIS,a.EMAIL, a.NUM_PEDIDOS,a.IMPORTE_NETO,a.IMPORTE_BRUTO from(#(lf)select A.ID_PAIS,EMAIL, count(distinct ID_PEDIDO_ECOMMERCE)  AS NUM_PEDIDOS,sum(IMPORTE_REAL*CAMBIO_REFERENCIA) as IMPORTE_NETO,sum(IMPORTE_PEDIDO*CAMBIO_REFERENCIA) as IMPORTE_BRUTO#(lf)      from (select a11.ID_PAIS ID_PAIS,EMAIL,ID_PEDIDO_ECOMMERCE,IMPORTE_REAL,IMPORTE_PEDIDO, CAMBIO_REFERENCIA#(tab)#(lf)            from dbo_st.stg_ult_estado_linea_pedido_st a11#(lf)#(tab)#(tab)#(tab)join dbo_itx.STG_MONEDA a12 on a11.ID_MONEDA = a12.ID_MONEDA#(lf)#(tab)#(tab)#(tab)join dbo_st.stg_dim_usuario_ecomm_st#(tab)a13 on #(tab)a11.ID_USUARIO_ECOMM = a13.ID_USUARIO_ECOMM#(lf)#(tab)#(tab)#(tab)join dbo_itx.STG_TIEMPO T on cast(a11.FECHA_PEDIDO as date) = cast(T.ID_FECHA as date)#(lf)            where FECHA_PEDIDO_LOCAL >= @FechaIni and FECHA_PEDIDO_LOCAL <= @FechaFin#(lf)            and FECHA_CANCELADO is null and FECHA_PEDIDO_LOCAL is not null#(lf)            and ID_CADENA in (6, 15) and ID_CENTRO_COMPRA in (2, 13, 16, 31) #(lf)            and ID_TIPO_DISPOSITIVO <> 5#(lf)            and a11.ID_PAIS in (1,2,38,4,5,6,3,30,11,25,21,10)) A#(lf)      group by A.ID_PAIS,EMAIL) a /*where a.Ranking <=10*/) A#(lf)#(tab) join (select /*a.ID_PAIS,*/a.EMAIL,a.RanKing,a.IMPORTE_NETO from(#(lf)#(tab)#(tab)select /*A.ID_PAIS,*/EMAIL, count(distinct ID_PEDIDO_ECOMMERCE)  AS NUM_PEDIDOS,sum(IMPORTE_REAL*CAMBIO_REFERENCIA) as IMPORTE_NETO,sum(IMPORTE_PEDIDO*CAMBIO_REFERENCIA) as IMPORTE_BRUTO,#(lf)#(tab)#(tab)RANK() OVER(ORDER BY sum(IMPORTE_REAL*CAMBIO_REFERENCIA) DESC) AS RanKing#(lf)#(tab)#(tab)from (select a11.ID_PAIS ID_PAIS,EMAIL,ID_PEDIDO_ECOMMERCE,IMPORTE_REAL,IMPORTE_PEDIDO, CAMBIO_REFERENCIA#(tab)#(lf)            from dbo_st.stg_ult_estado_linea_pedido_st a11#(lf)#(tab)#(tab)#(tab)join dbo_itx.STG_MONEDA a12 on a11.ID_MONEDA = a12.ID_MONEDA#(lf)#(tab)#(tab)#(tab)join dbo_st.stg_dim_usuario_ecomm_st#(tab)a13 on #(tab)a11.ID_USUARIO_ECOMM = a13.ID_USUARIO_ECOMM#(lf)#(tab)#(tab)#(tab)join dbo_itx.STG_TIEMPO T on cast(a11.FECHA_PEDIDO as date) = cast(T.ID_FECHA as date)#(lf)            where FECHA_PEDIDO_LOCAL >= @FechaIniA1 and FECHA_PEDIDO_LOCAL <= @FechaFinA1#(lf)            and FECHA_CANCELADO is null and FECHA_PEDIDO_LOCAL is not null#(lf)            and ID_CADENA in (6, 15) and ID_CENTRO_COMPRA in (2, 13, 16, 31) #(lf)            and ID_TIPO_DISPOSITIVO <> 5#(lf)            and a11.ID_PAIS in (1,2,38,4,5,6,3,30,11,25,21,10)) A#(lf)      group by /*A.ID_PAIS,*/EMAIL) a where a.Ranking <=3800) B on (A.EMAIL = B.EMAIL/* and A.ID_PAIS = B.ID_PAIS*/)#(lf)#(tab) group by A.ID_PAIS,A.EMAIL,B.RanKing,B.IMPORTE_NETO#(lf))  TOTAL_ANO#(lf)join #(lf)(select /*a.ID_PAIS,*/a.EMAIL,a.IMPORTE_NETO from(#(lf)#(tab)#(tab)select /*A.ID_PAIS,*/EMAIL, count(distinct ID_PEDIDO_ECOMMERCE)  AS NUM_PEDIDOS,sum(IMPORTE_REAL*CAMBIO_REFERENCIA) as IMPORTE_NETO,sum(IMPORTE_PEDIDO*CAMBIO_REFERENCIA) as IMPORTE_BRUTO#(lf)#(tab)#(tab)from (select a11.ID_PAIS ID_PAIS,EMAIL,ID_PEDIDO_ECOMMERCE,IMPORTE_REAL,IMPORTE_PEDIDO, CAMBIO_REFERENCIA#(tab)#(lf)            from dbo_st.stg_ult_estado_linea_pedido_st a11#(lf)#(tab)#(tab)#(tab)join dbo_itx.STG_MONEDA a12 on a11.ID_MONEDA = a12.ID_MONEDA#(lf)#(tab)#(tab)#(tab)join dbo_st.stg_dim_usuario_ecomm_st#(tab)a13 on #(tab)a11.ID_USUARIO_ECOMM = a13.ID_USUARIO_ECOMM#(lf)#(tab)#(tab)#(tab)join dbo_itx.STG_TIEMPO T on cast(a11.FECHA_PEDIDO as date) = cast(T.ID_FECHA as date)#(lf)            where FECHA_PEDIDO_LOCAL >= (select FECHA_MISMO_DIA_CALENDARIO from dbo_itx.STG_TIEMPO T where cast(@FechaIni as date) = cast(T.ID_FECHA as date))#(lf)#(tab)#(tab)#(tab)and FECHA_PEDIDO_LOCAL <= (select FECHA_MISMO_DIA_CALENDARIO from dbo_itx.STG_TIEMPO T where cast(@FechaFin as date) = cast(T.ID_FECHA as date))#(lf)            and FECHA_CANCELADO is null and FECHA_PEDIDO_LOCAL is not null#(lf)            and ID_CADENA in (6, 15) and ID_CENTRO_COMPRA in (2, 13, 16, 31) #(lf)            and ID_TIPO_DISPOSITIVO <> 5#(lf)            and a11.ID_PAIS in (1,2,38,4,5,6,3,30,11,25,21,10)) A#(lf)      group by /*A.ID_PAIS,*/EMAIL) a)  MMDD  on (MMDD.EMAIL = TOTAL_ANO.EMAIL) group by TOTAL_ANO.ID_PAIS#(lf)) MMDD on (BASE.ID_PAIS = MMDD.ID_PAIS)", CreateNavigationProperties=false, CommandTimeout=#duration(0, 10, 0, 0)])
in
    Origen